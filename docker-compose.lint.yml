version: '3.8'

services:
  # Linting and code quality tools (no volume mounts - uses container files)
  linter:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    env_file: .env
    working_dir: /app
    profiles:
      - lint
    # Override entrypoint to allow running different commands
    entrypoint: []

  # Format code with black and ruff (needs volume mounts to modify files)
  formatter:
    extends: linter
    volumes:
      # For formatting, we need to write back to files
      - .:/app
      - /app/.venv
      - /app/.pytest_cache
      - /app/.mypy_cache
      - /app/.ruff_cache
    command: >
      sh -c "
        echo 'ğŸ¨ Formatting code with black...' &&
        black . &&
        echo 'ğŸ¨ Organizing imports with ruff...' &&
        ruff check --fix --select I . &&
        echo 'âœ… Code formatting completed'
      "

  # Run ruff linter (uses container files)
  ruff:
    extends: linter
    command: >
      sh -c "
        echo 'ğŸ” Running ruff linter...' &&
        ruff check . &&
        echo 'âœ… Linting completed'
      "

  # Run mypy type checking (uses container files)
  mypy:
    extends: linter
    command: >
      sh -c "
        echo 'ğŸ” Running mypy type checking...' &&
        mypy . &&
        echo 'âœ… Type checking completed'
      "

  # Run bandit security scan (uses container files)
  bandit:
    extends: linter
    volumes:
      # Only mount for output file
      - .:/app/output
    command: >
      sh -c "
        echo 'ğŸ”’ Running bandit security scan...' &&
        bandit -r . -f json -o /app/output/bandit-report.json || true &&
        echo 'ğŸ“Š Security scan completed (see bandit-report.json)' &&
        bandit -r . &&
        echo 'âœ… Security scan completed'
      "

  # Run all quality checks (uses container files)
  check-all:
    extends: linter
    command: >
      sh -c "
        echo 'ğŸ” Running ruff linter...' &&
        ruff check . &&
        echo 'ğŸ” Running mypy type checking...' &&
        mypy . &&
        echo 'ğŸ”’ Running bandit security scan...' &&
        bandit -r . &&
        echo 'âœ… All code quality checks completed'
      " 