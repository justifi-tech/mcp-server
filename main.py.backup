#!/usr/bin/env python3
"""JustiFi MCP Server - Configuration-Driven Payment Integration

A Model Context Protocol (MCP) server that provides AI agents with tools
to interact with the JustiFi API. Supports Streamable HTTP
transport for secure network connectivity.

Usage:
    # Basic usage (stdio mode)
    python main.py

    # HTTP server mode (for network connectivity)
    MCP_SERVER_PORT=3000 python main.py

    # With health check
    python main.py --health-check

    # With tool selection (container-friendly)
    JUSTIFI_ENABLED_TOOLS=all python main.py
    JUSTIFI_ENABLED_TOOLS="retrieve_payout,list_payouts" python main.py
"""
import asyncio
import logging
import os
import sys
from typing import Any

from dotenv import load_dotenv
from mcp import stdio_server

# Import the new toolkit system
from justifi_mcp.config import JustiFiConfig
from justifi_mcp.toolkit import JustiFiToolkit


def setup_logging(log_level: str = "INFO") -> None:
    """Configure logging for the MCP server."""
    logger = logging.getLogger()

    # Validate log level
    valid_levels = {"DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"}
    if log_level not in valid_levels:
        log_level = "INFO"

    # Configure logging
    logging.basicConfig(
        level=getattr(logging, log_level),
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        handlers=[
            # Only log to stderr to avoid interfering with MCP stdio communication
            logging.StreamHandler(sys.stderr)
        ],
    )

    # Create logger for this module
    logger.info(f"Logging configured at {log_level} level")


async def health_check(toolkit: JustiFiToolkit) -> dict[str, Any]:
    """Simple health check to verify JustiFi API connectivity."""
    logger = logging.getLogger(__name__)

    try:
        logger.debug("Starting health check...")

        # Create a temporary MCP adapter to access the client
        from justifi_mcp.adapters.mcp import MCPAdapter

        adapter = MCPAdapter(toolkit.config)
        token = await adapter.client.get_access_token()
        config_summary = toolkit.get_configuration_summary()

        logger.debug("Health check completed successfully")

        return {
            "status": "healthy",
            "token_acquired": bool(token),
            "configuration": config_summary,
        }
    except Exception as e:
        logger.error(f"Health check failed: {e}")
        return {"status": "unhealthy", "error": str(e)}


def load_configuration() -> JustiFiConfig:
    """Load configuration from environment variables (container-friendly)."""
    logger = logging.getLogger(__name__)

    # Check for custom tool configuration via environment variable
    enabled_tools_env = os.getenv("JUSTIFI_ENABLED_TOOLS")
    if enabled_tools_env:
        logger.debug(f"Found JUSTIFI_ENABLED_TOOLS: {enabled_tools_env}")
        if enabled_tools_env.lower() == "all":
            return JustiFiConfig(enabled_tools="all")
        else:
            # Parse comma-separated list
            enabled_tools_list = [tool.strip() for tool in enabled_tools_env.split(",")]
            logger.debug(f"Parsed enabled tools: {enabled_tools_list}")
            return JustiFiConfig(enabled_tools=enabled_tools_list)

    # Default configuration (no tools enabled - secure by default)
    logger.debug("Using default configuration (no tools enabled)")
    return JustiFiConfig()


async def main():
    """Main entry point for the MCP server."""
    setup_logging(os.getenv("LOG_LEVEL", "INFO"))

    logger = logging.getLogger(__name__)
    logger.info("Starting JustiFi MCP Server initialization...")

    # Load environment variables first
    load_dotenv()

    # Load configuration
    try:
        config = load_configuration()
        logger.debug("Configuration loaded successfully")
    except Exception as e:
        logger.error(f"Failed to load configuration: {e}")
        raise

    toolkit = JustiFiToolkit(config=config)
    logger.debug("Toolkit initialized successfully")

    # Optional health check on startup
    if "--health-check" in sys.argv:
        logger.info("Performing JustiFi API health check...")
        print("Performing JustiFi API health check...", file=sys.stderr)
        health_result = await health_check(toolkit)

        if health_result["status"] == "healthy":
            logger.info("Health check passed")
            print("‚úÖ JustiFi API connection successful", file=sys.stderr)
            print(
                f"üìä Configuration: {health_result['configuration']}", file=sys.stderr
            )
        else:
            logger.error(f"Health check failed: {health_result['error']}")
            print(
                f"‚ùå JustiFi API connection failed: {health_result['error']}",
                file=sys.stderr,
            )
            sys.exit(1)

    # Get configuration summary for startup info
    config_summary = toolkit.get_configuration_summary()
    enabled_tools = config_summary["enabled_tools"]

    logger.info(f"Server configured with {len(enabled_tools)} enabled tools")
    logger.debug(f"Enabled tools: {enabled_tools}")
    logger.debug(f"Base URL: {config_summary['base_url']}")
    logger.debug(f"Environment: {config_summary['environment']}")

    print(
        "üöÄ Starting JustiFi MCP Server with Configuration Support...", file=sys.stderr
    )
    print(f"üåç Environment: {config_summary['environment']}", file=sys.stderr)
    print(
        f"üìä Enabled tools ({len(enabled_tools)}): {', '.join(enabled_tools)}",
        file=sys.stderr,
    )
    print(f"‚ö° Base URL: {config_summary['base_url']}", file=sys.stderr)
    print(f"‚è±Ô∏è  Timeout: {config_summary['timeout']}s", file=sys.stderr)

    # Get the configured MCP server
    server = toolkit.get_mcp_server("justifi-mcp-server")
    logger.info("MCP server ready, starting stdio communication...")

    # Run the stdio server
    async with stdio_server() as streams:
        await server.run(streams[0], streams[1], server.create_initialization_options())


if __name__ == "__main__":
    asyncio.run(main())


def cli_main():
    """Console script entry point."""
    asyncio.run(main())
